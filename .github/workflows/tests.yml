name: Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

# Restrict permissions to minimum required
permissions:
  contents: read
  actions: read
  checks: write

# Prevent concurrent workflow runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Pin versions for reproducibility
  PYTHON_VERSION_PRIMARY: "3.14"
  # Disable analytics/telemetry
  GRADIO_ANALYTICS_ENABLED: "false"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements-ci.txt', 'requirements-test.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Use CI-specific requirements (excludes GPU packages like torch, faster-whisper)
        # GPU dependencies are mocked in conftest.py for testing
        pip install -r requirements-ci.txt
        pip install -r requirements-test.txt
    
    - name: Run unit tests
      run: |
        pytest tests/ -m unit -v --cov=. --cov-report=xml --cov-report=term
    
    - name: Run integration tests
      run: |
        pytest tests/ -m integration -v
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: matrix.python-version == env.PYTHON_VERSION_PRIMARY
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 7
  
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Run Bandit security scan
      run: |
        bandit -r . -x ./tests,./venv,./.venv -f json -o bandit-report.json -ll
      continue-on-error: true
    
    - name: Check for high severity issues
      run: |
        # Fail if any high or critical severity issues found
        if grep -q '"severity": "HIGH"\|"severity": "CRITICAL"' bandit-report.json 2>/dev/null; then
          echo "::error::High or critical severity security issues found"
          cat bandit-report.json
          exit 1
        fi
    
    - name: Run Safety check
      run: |
        safety check --full-report || true
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: bandit-report.json
        retention-days: 30
  
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort
    
    - name: Run flake8 (critical errors)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Run flake8 (style warnings)
      run: |
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run black check
      run: |
        black --check --diff .
      continue-on-error: true
    
    - name: Run isort check
      run: |
        isort --check-only --diff .
      continue-on-error: true

  # Container build and service tests
  container:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test, security]  # Only run after unit tests and security checks pass
    
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build container image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: youlama:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Security: Don't include build secrets in image
        no-cache-filters: |
          secrets
    
    - name: Scan container for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'youlama:test'
        format: 'table'
        exit-code: '0'  # Don't fail on vulnerabilities (informational)
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'
      continue-on-error: true
    
    - name: Start container for testing
      run: |
        docker run -d \
          --name youlama-app \
          -p 127.0.0.1:7860:7860 \
          --cap-drop ALL \
          --security-opt no-new-privileges:true \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid \
          youlama:test
        
        # Wait for container to be ready (up to 120 seconds)
        echo "Waiting for container to be ready..."
        for i in {1..24}; do
          if curl -s http://127.0.0.1:7860 > /dev/null 2>&1; then
            echo "Container is ready!"
            break
          fi
          if [ $i -eq 24 ]; then
            echo "Container failed to start"
            docker logs youlama-app 2>&1 | head -100
            exit 1
          fi
          sleep 5
        done
    
    - name: Set up Python for container tests
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_PRIMARY }}
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests
    
    - name: Run container smoke tests
      run: |
        pytest tests/test_container_service.py -v -m smoke --container-url=http://127.0.0.1:7860
    
    - name: Run container health tests
      run: |
        pytest tests/test_container_service.py -v -m "container and not slow" --container-url=http://127.0.0.1:7860
      continue-on-error: true
    
    - name: Run container security tests
      run: |
        pytest tests/test_container_service.py -v -m "container and security" --container-url=http://127.0.0.1:7860
    
    - name: Run Docker integration tests
      run: |
        pytest tests/test_container_service.py -v -m docker --container-url=http://127.0.0.1:7860
    
    - name: Collect container logs on failure
      if: failure()
      run: |
        echo "=== Container Logs (last 100 lines) ==="
        docker logs youlama-app 2>&1 | tail -100
        echo "=== Container Status ==="
        docker inspect --format='{{.State.Status}}' youlama-app
    
    - name: Cleanup
      if: always()
      run: |
        docker stop youlama-app || true
        docker rm youlama-app || true